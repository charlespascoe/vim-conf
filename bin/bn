#!/bin/bash

if [ -z "$BN_HOME" ] || [ ! -d "$BN_HOME" ]; then
    echo "BN_HOME not set or not a directory"
    exit 1
fi

if [ "$#" -eq 0 ]; then
    echo "Usage: bn COMMAND"
    exit 1
fi

function ec() {
    local colour="$1"
    local message="$2"

    echo -e '\033[38;5;'"$colour"'m'"$message"'\033[0m'
}

function push() {
    local diff="$(git diff $1 origin/$1)"

    if [ -n "$diff" ]; then
        ec 45 "\nPushing changes..."
        git push
    fi
}


# Enabled extended globbing for f?vs matching
shopt -s extglob


case $1 in
    inbox)
        if [ "$#" -lt 2 ] || [ "$#" -gt 3 ]; then
            echo "Usage: bn inbox PROJECT [TITLE]"
            exit 1
        fi

        proj="$2"

        if [ ! -d "$BN_HOME/$proj" ]; then
            ec 196 "Project not found: $proj"
            exit 1
        fi

        export BN_PROJ=1

        # TODO: Handle uncommited changes before pushing
        cd "$BN_HOME/$proj" && \
        ec 45 "Pulling latest changes..." && \
        git pull --rebase && \
        vim -c "Inbox $3" && \
        push "$proj"

        exit $?

        ;;

    journal)
        if [ "$#" -ne 2 ]; then
            echo "Usage: bn journal PROJECT"
            exit 1
        fi

        proj="$2"

        if [ ! -d "$BN_HOME/$proj" ]; then
            ec 196 "Project not found: $proj"
            exit 1
        fi

        export BN_PROJ=1

        # TODO: Handle uncommited changes before pushing
        cd "$BN_HOME/$proj" && \
        ec 45 "Pulling latest changes..." && \
        git pull --rebase && \
        vim -c "Journal" && \
        push "$proj"

        exit $?

        ;;

    fes|es)
        if [ "$#" -ne 2 ]; then
            echo "Usage: bn $1 PROJECT"
            exit 1
        fi

        proj="$2"

        if [ ! -d "$BN_HOME/$proj" ]; then
            ec 196 "Project not found: $proj"
            exit 1
        fi

        export BN_PROJ=1

        cmd="$1 -c BulletnotesAsyncStart"

        if [ $1 == 'fes' ]; then
            cmd="$1 -c BulletnotesAsyncStartIndex"
        fi

        # TODO: Handle uncommited changes before pushing
        # TODO: Conditionally push based on commits
        #ec 45 "Pulling latest changes..." && \
        #git pull --rebase && \
        cd "$BN_HOME/$proj" && \
        source ~/.dotfiles/vim_aliases && \
        $cmd && \
        push "$proj"

        exit $?

        ;;


    newproj)
        if [ "$#" -ne 2 ]; then
            echo  "Usage: bn newproj PROJECT"
            exit 1
        fi

        if [ -z "$BN_NEW_REMOTE" ] || [ ! -x "$BN_NEW_REMOTE" ]; then
            echo "BN_NEW_REMOTE not set to the path of an executable program"
            exit 1
        fi

        proj="$(echo -n "$2" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | tr -dc '[:alnum:]-')"

        if [ -d "$BN_HOME/$proj" ]; then
            ec 196 "Project '$proj' already exists"
            exit 1
        fi

        read -p "Are you sure you want to create the project $proj? " confirm

        if [ "$confirm" != 'y' ]; then
            exit
        fi

        ec 220 "\nCreating empty project directory..." && \
        mkdir "$BN_HOME/$proj" && \
        cd "$BN_HOME/$proj" && \
        mkdir -p .bnproj/{spell,snips} inbox ref && \
        touch {.bnproj/{spell,snips},inbox,ref}/.keep && \

        ec 220 "\nInitialising git repo..." && \
        git init && \
        git config commit.gpgsign false && \
        git checkout -b "$proj"
        rm -f .git/hooks/* && \

        ec 220 "\nCommitting empty project..." && \
        git add --all && \
        git commit -m 'Initial Commit' && \

        ec 220 "\nCreating remote repo..." && \
        remote="$($BN_NEW_REMOTE "$proj")" && \
        git remote add origin "$remote" && \

        ec 220 "\nPushing to remote repo..." && \
        git push -u origin "$proj" && \

        ec 46 "\nDone!\n"

        exit $?

        ;;


    clone)
        if [ "$#" -ne 2 ]; then
            echo  "Usage: bn clone PROJECT"
            exit 1
        fi

        if [ -z "$BN_GET_REMOTE" ] || [ ! -x "$BN_GET_REMOTE" ]; then
            echo "BN_GET_REMOTE not set to the path of an executable program"
            exit 1
        fi

        proj="$2"

        if [ -d "$BN_HOME/$proj" ]; then
            echo "Project '$proj' already exists"
            exit 1
        fi

        cd "$BN_HOME" && \
        git clone "$($BN_GET_REMOTE "$proj")" "$proj" && \
        cd "$proj" && \
        git config commit.gpgsign false && \
        rm -f .git/hooks/* && \
        git checkout "$proj"

        exit $?

        ;;

    ls)
        if [ "$2" == "remote" ]; then
            if [ -z "$BN_LS_REMOTE" ] || [ ! -x "$BN_LS_REMOTE" ]; then
                echo "BN_LS_REMOTE not set to the path of an executable program"
                exit 1
            fi

            $BN_LS_REMOTE | tee "$BN_HOME/remotes_cache"
            exit
        fi

        if [ -z $2 ]; then
            find "$BN_HOME" -maxdepth 1 -mindepth 1 -type d | xargs -L 1 basename | sort
            exit
        fi

        echo "Usage: bn ls [remote]"
        exit 1

        ;;


    *)

        echo "Unknown command: $1"
        exit 1

        ;;

esac

