#!/bin/bash

if [ -z "$BN_HOME" ] || [ ! -d "$BN_HOME" ]; then
    echo "BN_HOME not set or not a directory"
    exit 1
fi

if [ "$#" -eq 0 ]; then
    echo "Usage: bn COMMAND"
    exit 1
fi

case $1 in
    inbox)
        if [ "$#" -lt 2 ] || [ "$#" -gt 3 ]; then
            echo "Usage: bn inbox PROJECT [TITLE]"
            exit 1
        fi

        local proj="$2"

        if [ ! -d "$BN_HOME/$proj" ]; then
            echo "Project not found: $proj"
            exit 1
        fi

        # TODO: Handle uncommited changes before pushing
        export BN_PROJ=1 && \
        cd "$BN_HOME/$proj" && \
        git pull --rebase && \
        vim -c "Inbox $3" && \
        git push

        exit $?

        ;;


    vs)
        if [ "$#" -ne 2 ]; then
            echo "Usage: bn vs PROJECT"
            exit 1
        fi

        local proj="$2"

        if [ ! -d "$BN_HOME/$proj" ]; then
            echo "Project not found: $proj"
            exit 1
        fi

        # TODO: Handle uncommited changes before pushing
        export BN_PROJ=1 && \
        cd '$BN_HOME/$proj' && \
        git pull --rebase && \
        source ~/.bash_aliases && \
        vs && \
        git push

        exit $?

        ;;


    newproj)
        if [ "$#" -ne 2 ]; then
            echo  "Usage: bn newproj PROJECT"
            exit 1
        fi

        local proj="$2"

        if [ -d "$BN_HOME/$proj" ]; then
            echo "Project '$proj' already exists"
            exit 1
        fi

        read -p "Are you sure you want to create the project $proj? " confirm

        if [ "$confirm" != 'y' ]; then
            exit
        fi

        mkdir "$BN_HOME/$proj" && \
        cd "$BN_HOME/$proj" && \
        git init && \
        mkdir inbox archive ref future && \
        touch {inbox,archive,ref,future}/.keep && \
        touch .bnproj && \
        git add --all && \
        git commit -m 'Initial Commit' && \
        hub create -p "bulletnotes-$proj" && \
        git push -u origin master

        exit $?

        ;;


    clone)
        if [ "$#" -ne 2 ]; then
            echo  "Usage: bn clone PROJECT"
            exit 1
        fi

        local proj="$2"

        if [ -d "$BN_HOME/$proj" ]; then
            echo "Project '$proj' already exists"
            exit 1
        fi

        cd $BN_HOME && \
        hub clone 'bulletnotes-$proj' '$proj'

        exit $?

        ;;


    *)

        echo "Unknown command: $1"
        exit 1

        ;;

esac

